# Active Recordの基礎
- active record
  - データベースの行をラップし、データベースへの接続をカプセル化し、データにドメインロジックを追加するオブジェクト
	  - 「Patterns of Enterprise Application Architecture」by Martin Fowler
	- データと振る舞いをもつ
- ORM(オブジェクトリレーショナルマッピング)
  - プログラミング言語のリッチなオプジェクトとデータベースのレコードを接続する技術
	- 直接SQLを書くことなく、データの読み取り、書き込みが可能
	- クエリを記述する量を必要最低限にすることが可能
- RailsのActive Recordで何ができる？
  - モデルとモデル内のデータを表現する
	- モデル間の関連づけ（association）を表す
	- 関連づけられたモデル間の継承関係を表す
	- バリデーションができる
	- データベースをオブジェクト指向スタイルで操作する
- Convention over Configuration(設定より規約)
  - アプリケーションを作る際に、多くの場合に同じ設定をするのであれば、そもそもそれをアプリケーションのデフォルトにしてしまおうって思想
	- ↑により従わないといけない規約が存在するが従うことでコード量は少なく済む
- 命名規約
  - モデル名は単数系、キャメルケース
	- テーブル名は複数形、スネークケース
	- モデル/クラス, テーブル/スキーマ
	  - Product, products
		- LineItem, line_items
- スキーマ規約
  - 主キー
		- id(mysqlではbigint, マイグレーション時に自動的に付与される)
		- 主キーとしてidをデフォルトで使うよってこと
	- 外部キー
	  - モデル名_id(list_item_id)
		- モデル間の関連付けを探すときにActive Recordが利用
	- 予約されてるやつ
	  - updated_at, created_at
		- type(STI)
		- モデル名_count, 関連先のテーブルのキャッシュ
- モデルの作成
  - `ApplicationRecord < ActiveRecord::Base`
	  - 通常のrubyクラスがActive Recordモデルに変える
  - `class Book < ApplicationRecord end`
	  - データベース内の`books`テーブルと対応づけられる
		- テーブル内の各カラムが`Book`クラスの属性に対応付けられる
		- `Book`モデルの1個のインスタンスが、`books`テーブル内の１行を表現する
	- テーブルの作成は基本、Active Recordのマイグレーションで行う
	  - `bin/rails g migration CreateBooks title:string, author`
		- 型をつけないとデフォルトでstringになる
	- 名前空間付きモデルを作成する
		- デフォルトでは`app/models`に配置
		- `bin/rails g model Book::Order`
			- `class Book::Order < ApplicationRecord`
			- テーブル名が親のモデル名をprefixにつけた形になる
				- `book_orders`になる
- 命名規約を上書きする
	- `ActiveRecord::Base`を継承してるから使える
	- テーブル名
		- `self.table_name = "my_books"`と上書きできる
	- 主キー
		- `self.primary_key = "book_id"`
		- ↑主キー以外のカラムに`id`をつけるべきではない
- CRUD
	- Create, Read, Update, Delete
		- Active Recordが自動的に用意してくれる
		- 背後のDBに対して、SQLを発行している
	- Create
		- `create`
			- 新しいオブジェクトが返され、DBにも保存される
		- DBにコミットするときに`id`が自動的に割り振られる
			- `create` -> idあり
			- `new` -> idなし
			- `save` -> idあり
		- `new`は新しいオブジェクトを返すだけ
		- `save`でデータベースに保存
		- コールバックやバリデーションをトリガーせずにDBに保存したいとき
			- `insert`
			- `insert_all`
	- Read
		- データを取ってくるAPI
			- `Book.all`, `Book.first`などなど
			- `find_by`, `where`
			- 他にもたくさんある
	- Update
		- オブジェクトの属性を変更して、DBに保存することができる
			- `book.update(title: "The Lord of the Rings: The Fellowship of the Ring")`
		- コールバックやバリデーションをトリガーしたくないとき
			- `update_all`
	- Delete
		- データベースからオブジェクトを削除する
			- `book.destroy`
		- 複数レコードを一括削除したいとき
			- `Book.destroy_by(author: "Douglas Adams")`
			- `Book.destroy_all`
		- コールバックやバリデーションをトリガーしたくないとき
			- `Book.find_by(title: "The Load of the Rings").delete`
			- `Book.delete_all`
- バリデーション
	- データベースに書き込まれる前にモデルの状態を検証することができる
		- `save`, `create`, `update`はデータを永続化する前にバリデーションを行う
		- `validates :name, presence: true`
- コールバック
	- モデルのライフサイクル内で特定のイベントにコードをアタッチできる
		- モデルの特定のイベントでコードを実行できる
- マイグレーション
	- データベーススキーマを管理するためのDSL
	- マイグレーションをファイルに保存して、`bin/rails db`を実行するとDBに対してマイグレーションが実行される
- 関連付け(association)
	- 関連付けを利用することでモデル間のリレーションシップ（関係）を定義できる
	- １対１、１対多、多対多の関係がある
	- `has_many :books`みたいな感じ
